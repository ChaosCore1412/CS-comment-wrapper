        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <link rel="shortcut icon" href="https://raw.githubusercontent.com/ChaosCore1412/CS-comment-wrapper/refs/heads/main/icons/Buh.png">
            <title>The Last CS · forum</title>
            <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
            <style>/* === complete style – same vibe with additions === */
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { background: #f0f3f8; font-family: 'Segoe UI', Roboto, sans-serif; display: flex; justify-content: center; padding: 30px 16px; min-height: 100vh; }
                .forum-container { max-width: 880px; width: 100%; background: white; border-radius: 28px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.2); overflow: hidden; }
                .forum-header { padding: 28px 32px 12px 32px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #e6ecf3; }
                .forum-header h2 { font-weight: 550; color: #0b1a2a; }
                .user-greeting { margin-left: auto; display: flex; align-items: center; gap: 12px; background: #edf2f9; border-radius: 40px; padding: 4px 18px 4px 12px; }
                .user-greeting i { color: #2e9afe; }
                #settingsToggleBtn { background: none; border: none; font-size: 1.4rem; cursor: pointer; color: #2c3e50; margin-right: 8px; }
                .new-thread-card { background: #f8fafd; margin: 22px 30px 28px 30px; padding: 24px; border-radius: 28px; border: 1px solid #dee7f0; }
                .input-group textarea { width: 100%; padding: 16px 20px; border: 2px dashed #b9cadb; border-radius: 30px; font-size: 1rem; background: white; resize: vertical; line-height: 1.5; }
                .input-group textarea:focus { border-color: #2e9afe; outline: none; box-shadow: 0 0 0 3px rgba(46,154,254,0.2); border-style: solid; }
                .drag-over { border-color: #2e9afe !important; background: #e8f0fe !important; }
                .format-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
                .format-btn { background: white; border: 1px solid #cbd6e3; padding: 6px 14px; border-radius: 40px; cursor: pointer; }
                .format-btn:hover { background: #e2ecf7; }
                #colorPicker { width: 40px; height: 36px; border-radius: 30px; border: none; vertical-align: middle; }
                .preview-area { display: flex; flex-wrap: wrap; gap: 12px; margin: 15px 0 8px; }
                .thumb-preview { position: relative; width: 70px; height: 70px; border-radius: 18px; overflow: hidden; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
                .thumb-preview img { width: 100%; height: 100%; object-fit: cover; }
                .remove-preview { position: absolute; top: -4px; right: -4px; background: #ff4d4f; color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid white; }
                .file-attach-row { display: flex; align-items: center; flex-wrap: wrap; gap: 18px; margin: 16px 0 10px; }
                .custom-file-label { background: #eef2f6; padding: 8px 20px; border-radius: 40px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
                .send-main-btn { background: #2e9afe; border: none; color: white; padding: 10px 32px; border-radius: 40px; font-weight: 600; cursor: pointer; border: 1px solid #1a7fd1; transition: 0.2s; }
                .send-main-btn:disabled { opacity: 0.5; cursor: not-allowed; }
                .thread-list { padding: 0 30px 40px 30px; }
                .comment-card, .reply-card { margin-bottom: 24px; border-bottom: 1px solid #ecf1f7; padding-bottom: 20px; position: relative; }
                .comment-header { display: flex; align-items: center; gap: 12px; margin-bottom: 6px; }
                .comment-avatar img { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; background: #b7c9dd; }
                .comment-author { font-weight: 600; }
                .comment-id-badge { background: #eef3f8; padding: 2px 12px; border-radius: 40px; font-size: 0.75rem; }
                .comment-time { font-size: 0.8rem; color: #64748b; margin-left: auto; }
                .comment-body { margin-left: 54px; }
                .comment-content { line-height: 1.5; }
                .comment-content b, .comment-content strong { font-weight: 600; }
                .comment-content i, .comment-content em { font-style: italic; }
                .comment-content span[style*="color"] { display: inline; }
                .comment-image { display: flex; flex-wrap: wrap; gap: 12px; margin: 12px 0 6px; }
                .comment-image img { max-width: 180px; max-height: 180px; border-radius: 16px; border: 1px solid #dde3ec; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
                .comment-actions { margin-left: 54px; margin-top: 10px; display: flex; gap: 12px; align-items: center; }
                .reply-toggle-btn { background: none; border: none; color: #2e9afe; font-weight: 500; cursor: pointer; }
                .reply-box-nested { margin-left: 54px; margin-top: 15px; background: #f9fcff; border-radius: 24px; padding: 18px; border: 1px solid #d7e2ee; display: none; }
                .reply-box-nested textarea { width: 100%; border-radius: 30px; border: 1px solid #b9ccdf; padding: 10px 18px; }
                .send-reply-mini { background: #2e9afe; color: white; border: none; padding: 6px 22px; border-radius: 40px; margin-top: 10px; cursor: pointer; }
                .replies-section { margin-left: 54px; border-left: 3px solid #cfdeef; padding-left: 22px; }
                .forum-footer { padding: 16px 30px; background: #f5f9ff; border-top: 1px solid #dde5f0; display: flex; justify-content: space-between; }
                .live-dot { background: #1bb86b; width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
                /* three-dots menu */
                .comment-menu { position: absolute; top: 10px; right: 10px; }
                .menu-trigger { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #5f6c80; padding: 0 6px; }
                .menu-dropdown { position: absolute; right: 0; top: 30px; background: white; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); display: none; flex-direction: column; min-width: 120px; z-index: 100; border: 1px solid #d4e0ec; }
                .menu-dropdown.show { display: flex; }
                .menu-item { padding: 10px 16px; background: none; border: none; text-align: left; cursor: pointer; font-size: 0.95rem; }
                .menu-item:hover { background: #f0f5fc; }
                .menu-item.delete { color: #d14545; }
                /* auth overlay */
                .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 2000; }
                .overlay.active { display: flex; }
                .auth-modal, .settings-modal { background: white; width: 420px; border-radius: 40px; padding: 28px; box-shadow: 0 40px 80px black; }
                .settings-modal { width: 460px; }
                .auth-tabs { display: flex; gap: 20px; border-bottom: 1px solid #dae2ec; padding-bottom: 8px; }
                .auth-tab { background: none; border: none; font-weight: 600; color: #5c6f87; cursor: pointer; padding: 6px 0; }
                .auth-tab.active { color: #1f7ed3; border-bottom: 3px solid #1f7ed3; }
                .form-group { margin-bottom: 18px; }
                .form-group input { width: 100%; padding: 12px 20px; border-radius: 60px; border: 1px solid #bfd2e6; }
                .auth-btn, .settings-btn { background: #1f7ed3; color: white; border: none; padding: 12px; width: 100%; border-radius: 60px; font-weight: bold; cursor: pointer; }
                .close-modal { float: right; font-size: 2rem; background: none; border: none; cursor: pointer; }
                .enlarge-overlay { position: fixed; top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:none;justify-content: center;align-items: center;z-index:3000; }
                .enlarge-overlay.active { display: flex; }
                .enlarged-img { max-width: 90vw;max-height: 90vh; border-radius: 20px; }
                .close-enlarge { position: absolute; top:30px; right:40px; color: white; font-size: 3rem; cursor: pointer; }
                .profile-preview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin: 10px auto; display: block; border: 3px solid #b0c8e0; }
                .load-more-btn { display: flex; justify-content: center; margin: 25px 0 10px; }
                .load-more-btn button { background: #eef2f6; border: 1px solid #c0d0e3; padding: 10px 30px; border-radius: 60px; font-weight: 600; cursor: pointer; }
                .load-more-btn button:hover { background: #e0e9f3; }
                .show-more-icon { font-size: 1.2rem; }
                .small-note i { color: #6b7f99; }
                /* greyed-out syntax in textarea (simple hint via background) */
                .format-hint { opacity: 0.5; }
            </style>
        </head>
        <body>
            <!-- LOGIN OVERLAY -->
            <div class="overlay" id="authOverlay">
                <div class="auth-modal">
                    <button class="close-modal" id="closeModalBtn">&times;</button>
                    <div class="auth-tabs"><button class="auth-tab active" id="loginTab">Log in</button><button class="auth-tab" id="signupTab">Sign up</button></div>
                    <div class="auth-form" id="loginForm">
                        <div class="form-group"><input type="email" id="login-email" placeholder="Email"></div>
                        <div class="form-group"><input type="password" id="login-password" placeholder="Password"></div>
                        <button class="auth-btn" id="loginBtn"><i class="fas fa-sign-in-alt"></i> Log in</button>
                        <div class="auth-note" style="text-align:center; margin-top:16px;">No account? <button id="switchToSignup" style="background:none;border:none;color:#1f7ed3;">Sign up</button></div>
                    </div>
                    <div class="auth-form" id="signupForm" style="display:none;">
                        <div class="form-group"><input type="email" id="signup-email" placeholder="Email"></div>
                        <div class="form-group"><input type="text" id="signup-displayname" placeholder="Display name"></div>
                        <div class="form-group"><input type="password" id="signup-password" placeholder="Password"></div>
                        <button class="auth-btn" id="signupBtn"><i class="fas fa-user-plus"></i> Sign up</button>
                        <div class="auth-note">Already member? <button id="switchToLogin" style="background:none;border:none;color:#1f7ed3;">Log in</button></div>
                    </div>
                </div>
            </div>

            <!-- SETTINGS OVERLAY (profile) -->
            <div class="overlay" id="settingsOverlay">
                <div class="settings-modal">
                    <button class="close-modal" id="closeSettingsBtn">&times;</button>
                    <h3 style="margin-bottom: 20px;"><i class="fas fa-cog"></i> Profile settings</h3>
                    <div class="form-group"><input type="text" id="settingsDisplayName" placeholder="New display name"></div>
                    <div class="form-group"><label>Profile picture (click to upload)</label><input type="file" id="settingsAvatar" accept="image/*" style="margin-top:8px;"></div>
                    <img id="avatarPreview" class="profile-preview" src="https://img.freepik.com/premium-vector/default-avatar-profile-icon-social-media-user-image-gray-avatar-icon-blank-profile-silhouette-vector-illustration_561158-3407.jpg" alt="">
                    <button class="settings-btn" id="saveSettingsBtn"><i class="fas fa-save"></i> Update profile</button>
                    <div style="margin-top:15px; text-align:center"><button id="logoutBtnSettings" style="background:none; border:none; color:#b33;">Logout</button></div>
                </div>
            </div>

            <!-- image enlarge overlay -->
            <div class="enlarge-overlay" id="enlargeOverlay"><span class="close-enlarge" id="closeEnlarge">&times;</span><img class="enlarged-img" id="enlargedImg" src="" alt=""></div>

            <!-- MAIN FORUM -->
            <div class="forum-container">
                <div class="forum-header">
                    <i class="fas fa-comments" style="color:#2e9afe;"></i>
                    <h2>The Last CS <span style="font-weight:400;">/ forum</span></h2>
                    <!-- dynamic greeting + settings icon -->
                    <div id="greetingContainer"></div>
                    <button id="settingsToggleBtn" style="background:none; border:none; font-size:1.6rem; margin-left:6px;"><i class="fas fa-sliders-h"></i></button>
                    <button id="openLoginBtn" style="background:#edf2f9; border:none; border-radius:40px; padding:8px 18px;"><i class="far fa-user-circle"></i> Login</button>
                </div>

                <!-- new discussion card -->
                <div class="new-thread-card">
                    <h3><i class="fas fa-pencil-alt"></i> Start a new discussion</h3>
                    <div class="format-bar">
                        <button class="format-btn" id="boldBtn"><i class="fas fa-bold"></i></button>
                        <button class="format-btn" id="italicBtn"><i class="fas fa-italic"></i></button>
                        <button class="format-btn" id="colorBtn"><i class="fas fa-palette"></i> color</button>
                        <input type="color" id="colorPicker" value="#2e9afe">
                    </div>
                    <div class="input-group"><textarea id="messageInput" rows="3" placeholder="Write your comment or question... (drag & drop images)"></textarea></div>
                    <div class="preview-area" id="globalPreview"></div>
                    <div class="file-attach-row">
                        <label for="imageInput" class="custom-file-label"><i class="fas fa-image"></i> Attach images</label>
                        <input type="file" id="imageInput" accept="image/*" multiple style="display:none;">
                        <button class="send-main-btn" id="sendBtn"><i class="fas fa-paper-plane"></i> Post comment</button>
                    </div>
                    <div class="small-note"><i class="far fa-lightbulb"></i> **bold** *italic* <span style="color:#c6362e;">colors</span> and drag-drop images</div>
                </div>

                <div class="thread-list" id="chat"></div>
                <div class="load-more-btn" id="loadMoreContainer" style="display: none;"><button id="loadMoreBtn"><i class="fas fa-chevron-down"></i> Show more posts</button></div>

                <div class="forum-footer"><span><i class="far fa-comment-dots"></i> real‑time updates</span><span class="live-badge"><span class="live-dot"></span> live</span></div>
            </div>

            <script>
                (function() {
                    const SUPABASE_URL = "https://ixswnnjhjreoewlbnzhp.supabase.co";   // ← insert your supabase url
                    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml4c3dubmpoanJlb2V3bGJuemhwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNzA1MjgsImV4cCI6MjA4NzY0NjUyOH0.s6-SB78wtXb5SAro9FRvBvA292VxH2bJxOH22si3GpQ"; // ← insert anon key
                    const Supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                    // ---------- DOM elements ----------
                    const chatDiv = document.getElementById('chat');
                    const overlay = document.getElementById('authOverlay');
                    const settingsOverlay = document.getElementById('settingsOverlay');
                    const openLoginBtn = document.getElementById('openLoginBtn');
                    const closeModalBtn = document.getElementById('closeModalBtn');
                    const loginTab = document.getElementById('loginTab');
                    const signupTab = document.getElementById('signupTab');
                    const loginFormDiv = document.getElementById('loginForm');
                    const signupFormDiv = document.getElementById('signupForm');
                    const switchToSignup = document.getElementById('switchToSignup');
                    const switchToLogin = document.getElementById('switchToLogin');
                    const loginBtn = document.getElementById('loginBtn');
                    const signupBtn = document.getElementById('signupBtn');
                    const settingsToggleBtn = document.getElementById('settingsToggleBtn');
                    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
                    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
                    const logoutBtnSettings = document.getElementById('logoutBtnSettings');
                    const settingsAvatar = document.getElementById('settingsAvatar');
                    const avatarPreview = document.getElementById('avatarPreview');
                    const settingsDisplayName = document.getElementById('settingsDisplayName');
                    const greetingContainer = document.getElementById('greetingContainer');

                    // Post elements
                    const messageInput = document.getElementById('messageInput');
                    const globalPreview = document.getElementById('globalPreview');
                    const imageInput = document.getElementById('imageInput');
                    const sendBtn = document.getElementById('sendBtn');
                    const boldBtn = document.getElementById('boldBtn');
                    const italicBtn = document.getElementById('italicBtn');
                    const colorBtn = document.getElementById('colorBtn');
                    const colorPicker = document.getElementById('colorPicker');
                    const enlargeOverlay = document.getElementById('enlargeOverlay');
                    const enlargedImg = document.getElementById('enlargedImg');
                    const closeEnlarge = document.getElementById('closeEnlarge');

                    // State
                    let selectedFiles = [];
                    let currentUser = null;
                    let currentProfile = null;
                    let allMessages = [];           // flat list
                    let topLevelMessages = [];       // roots only
                    let renderedRootCount = 10;      // pagination limit
                    const PAGE_SIZE = 10;

                    // ---------- helper: relative time ----------
                        function timeAgo(dateStr) {
                            // Convert to ISO format
                            const iso = dateStr.replace(" ", "T"); 

                            const d = new Date(iso);
                            const now = new Date();
                            const seconds = Math.floor((now - d) / 1000);

                            if (seconds < 60) return `${seconds}s ago`;
                            const minutes = Math.floor(seconds / 60);
                            if (minutes < 60) return `${minutes}m ago`;
                            const hours = Math.floor(minutes / 60);
                            if (hours < 24) return `${hours}h ago`;
                            const days = Math.floor(hours / 24);
                            if (days < 7) return `${days}d ago`;
                            const weeks = Math.floor(days / 7);
                            if (weeks < 2) return `${weeks}w ago`;
                            return d.toLocaleDateString();
                        }



                    // ---------- auth & profile ----------
                    async function refreshUser() {
                        const { data: { user } } = await Supabase.auth.getUser();
                        currentUser = user;
                        if (user) {
                            const { data: profile } = await Supabase.from('user_profile').select('*').eq('id', user.id).single();
                            currentProfile = profile;
                            updateGreeting();
                        } else {
                            currentProfile = null;
                            greetingContainer.innerHTML = '';
                        }
                    }
                    function updateGreeting() {
                        if (currentProfile) {
                            greetingContainer.innerHTML = `<div class="user-greeting"><i class="fas fa-smile"></i> Welcome, ${currentProfile.display_name || 'member'}</div>`;
                            openLoginBtn.style.display = 'none';
                        } else {
                            greetingContainer.innerHTML = '';
                            openLoginBtn.style.display = 'inline-block';
                        }
                    }

                    // signup, login 
                    async function signUp() {
                        const email = document.getElementById('signup-email').value;
                        const password = document.getElementById('signup-password').value;
                        const displayName = document.getElementById('signup-displayname').value;
                        if (!displayName) return alert('Display name required');
                        const { data, error } = await Supabase.auth.signUp({ email, password });
                        if (error) return alert(error.message);
                        const userId = data.user.id;
                        await Supabase.from('user_profile').insert({ id: userId, display_name: displayName, image_url: 'https://img.freepik.com/premium-vector/default-avatar-profile-icon-social-media-user-image-gray-avatar-icon-blank-profile-silhouette-vector-illustration_561158-3407.jpg' });
                        alert('Signup successful! Check email if confirmation required.');
                        overlay.classList.remove('active');
                        refreshUser();
                    }
                    async function login() {
                        const email = document.getElementById('login-email').value;
                        const password = document.getElementById('login-password').value;
                        const { error } = await Supabase.auth.signInWithPassword({ email, password });
                        if (error) return alert(error.message);
                        overlay.classList.remove('active');
                        refreshUser();
                    }
                    async function logout() {
                        await Supabase.auth.signOut();
                        settingsOverlay.classList.remove('active');
                        refreshUser();
                        loadMessages();
                    }

                    // settings: update profile & avatar
                    settingsAvatar.addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (ev) => { avatarPreview.src = ev.target.result; };
                            reader.readAsDataURL(file);
                        }
                    });

                    saveSettingsBtn.addEventListener('click', async () => {
                        if (!currentUser) return alert('login first');
                        const newName = settingsDisplayName.value.trim();
                        const file = settingsAvatar.files[0];
                        let imageUrl = currentProfile?.image_url;
                        if (file) {
                            const ext = file.name.split('.').pop();
                            const path = `avatars/${currentUser.id}/${Date.now()}.${ext}`;
                            const { error: uploadErr } = await Supabase.storage.from('Images').upload(path, file);
                            if (!uploadErr) {
                                const { data: pub } = Supabase.storage.from('Images').getPublicUrl(path);
                                imageUrl = pub.publicUrl;
                            } else alert('upload failed');
                        }
                        const updates = {};
                        if (newName) updates.display_name = newName;
                        if (imageUrl) updates.image_url = imageUrl;
                        if (Object.keys(updates).length === 0) return;
                        const { error } = await Supabase.from('user_profile').update(updates).eq('id', currentUser.id);
                        if (error) alert(error.message);
                        else {
                            alert('profile updated');
                            settingsOverlay.classList.remove('active');
                            refreshUser();
                            loadMessages();
                        }
                    });

                    // ---------- post & edit/delete ----------
                    async function postMessage(content, files, parent_id = null) {
                        if (!content && (!files || files.length===0)) return alert('empty post');
                        if (!currentUser) return alert('You must be logged in');
                        sendBtn.disabled = true;
                        sendBtn.innerHTML = '<i class="fas fa-spinner fa-pulse"></i> posting...';
                        const { data: msg, error } = await Supabase.from('messages').insert({ content, parent_id, sender: currentUser.id }).select('id').single();
                        if (error) { console.error(error); alert('error'); sendBtn.disabled=false; sendBtn.innerHTML='<i class="fas fa-paper-plane"></i> Post comment'; return; }
                        if (files && files.length) {
                            for (const file of files) {
                                const path = `images/${currentUser.id}/${msg.id}/${Date.now()}-${file.name}`;
                                const { error: upErr } = await Supabase.storage.from('Images').upload(path, file);
                                if (!upErr) {
                                    const { data: pub } = Supabase.storage.from('Images').getPublicUrl(path);
                                    await Supabase.from('message_images').insert({ message_id: msg.id, image_url: pub.publicUrl });
                                }
                            }
                        }
                        await new Promise(r => setTimeout(r, 1000)); // 1s delay
                        sendBtn.disabled = false;
                        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Post comment';
                        messageInput.value = '';
                        selectedFiles = [];
                        updatePreview();
                        imageInput.value = '';
                        loadMessages();
                    }

                    // delete message
                    async function deleteMessage(messageId) {
                        if (!confirm('Delete message?')) return;
                        await Supabase.from('messages').delete().eq('id', messageId);
                        loadMessages();
                    }

                    // edit: prompt new content (simplified)
                    async function editMessage(messageId, oldContent) {
                        const newText = prompt('Edit your message:', oldContent);
                        if (newText !== null) {
                            await Supabase.from('messages').update({ content: newText }).eq('id', messageId);
                            loadMessages();
                        }
                    }

                    // ---------- load messages with pagination ----------
                    async function loadMessages() {
                        const { data, error } = await Supabase
                            .from('messages')
                            .select(`*, user_profile(display_name, image_url), message_images(image_url)`)
                            .order('created_at', { ascending: false });
                        if (error) return console.error(error);
                        allMessages = data;
                        // build tree
                        const map = {}; allMessages.forEach(m => { m.children = []; map[m.id] = m; });
                        allMessages.forEach(m => { if (m.parent_id && map[m.parent_id]) map[m.parent_id].children.push(m); });
                        topLevelMessages = allMessages.filter(m => !m.parent_id).sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
                        renderTopLevel();
                    }

                    function renderTopLevel() {
                        chatDiv.innerHTML = '';
                        const toShow = topLevelMessages.slice(0, renderedRootCount);
                        if (toShow.length === 0) { chatDiv.innerHTML = '<div class="empty-threads">No discussions yet.</div>'; }
                        else {
                            toShow.forEach(msg => {
                                chatDiv.appendChild(createMessageElement(msg, false));
                                if (msg.children.length) {
                                    const replyDiv = document.createElement('div');
                                    replyDiv.className = 'replies-section';
                                    chatDiv.appendChild(replyDiv);
                                    renderReplies(msg.children, replyDiv);
                                }
                            });
                        }
                        // show more button
                        const loadMoreDiv = document.getElementById('loadMoreContainer');
                        if (topLevelMessages.length > renderedRootCount) {
                            loadMoreDiv.style.display = 'block';
                        } else {
                            loadMoreDiv.style.display = 'none';
                        }
                    }
                    function renderReplies(children, container) {
                        children.sort((a,b)=> new Date(a.created_at)-new Date(b.created_at)).forEach(r => {
                            container.appendChild(createMessageElement(r, true));
                            if (r.children.length) {
                                const sub = document.createElement('div');
                                sub.className = 'replies-section';
                                container.appendChild(sub);
                                renderReplies(r.children, sub);
                            }
                        });
                    }

                    function createMessageElement(msg, isReply) {
                        const card = document.createElement('div');
                        card.className = isReply ? 'reply-card' : 'comment-card';
                        card.dataset.messageId = msg.id;
                        const profile = msg.user_profile || { display_name: 'anon', image_url: 'https://img.freepik.com/premium-vector/default-avatar-profile-icon-social-media-user-image-gray-avatar-icon-blank-profile-silhouette-vector-illustration_561158-3407.jpg' };
                        const displayName = profile.display_name || 'member';
                        const avatarUrl = profile.image_url;
                        const timeHtml = timeAgo(msg.created_at);
                        const headerHtml = `<div class="comment-header"><div class="comment-avatar"><img src="${avatarUrl}" alt=""></div><span class="comment-author">${displayName}</span><span class="comment-id-badge">#${msg.id.slice(0,4)}</span><span class="comment-time"><i class="far fa-clock"></i> ${timeHtml}</span></div>`;
                        let contentHtml = msg.content || '';
                        // convert markdown bold/italic to html (simple)
                        contentHtml = contentHtml.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\*(.*?)\*/g, '<i>$1</i>');
                        const bodyHtml = `<div class="comment-body"><div class="comment-content">${contentHtml}</div></div>`;
                        card.innerHTML = headerHtml + bodyHtml;

                        // images
                        if (msg.message_images?.length) {
                            const imgDiv = document.createElement('div');
                            imgDiv.className = 'comment-image';
                            msg.message_images.forEach(img => {
                                const im = document.createElement('img');
                                im.src = img.image_url;
                                im.addEventListener('click', () => { enlargedImg.src = img.image_url; enlargeOverlay.classList.add('active'); });
                                imgDiv.appendChild(im);
                            });
                            card.querySelector('.comment-body').appendChild(imgDiv);
                        }

                        // three-dot menu for own messages
                        if (currentUser && msg.sender === currentUser.id) {
                            const menuDiv = document.createElement('div');
                            menuDiv.className = 'comment-menu';
                            menuDiv.innerHTML = `<button class="menu-trigger"><i class="fas fa-ellipsis-v"></i></button><div class="menu-dropdown"><button class="menu-item edit-item"><i class="fas fa-edit"></i> Edit</button><button class="menu-item delete-item"><i class="fas fa-trash-alt"></i> Delete</button></div>`;
                            card.appendChild(menuDiv);
                            const trigger = menuDiv.querySelector('.menu-trigger');
                            const dropdown = menuDiv.querySelector('.menu-dropdown');
                            trigger.addEventListener('click', (e) => { e.stopPropagation(); dropdown.classList.toggle('show'); });
                            dropdown.querySelector('.edit-item').addEventListener('click', () => { editMessage(msg.id, msg.content); dropdown.classList.remove('show'); });
                            dropdown.querySelector('.delete-item').addEventListener('click', () => { deleteMessage(msg.id); dropdown.classList.remove('show'); });
                        }

                        // reply toggle (standard)
                        const replyBoxId = `replyBox-${msg.id}`;
                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'comment-actions';
                        actionsDiv.innerHTML = `<button class="reply-toggle-btn" data-target="${replyBoxId}"><i class="fas fa-reply"></i> Reply</button>`;
                        card.appendChild(actionsDiv);
                        const replyBox = document.createElement('div');
                        replyBox.className = 'reply-box-nested';
                        replyBox.id = replyBoxId;
                        replyBox.innerHTML = `<textarea rows="2" placeholder="Write a reply..."></textarea><div><label for="file-${msg.id}" class="mini-file-label" style="background:#eef2f6; padding:6px 16px; border-radius:40px; display:inline-block; margin:8px 0;"><i class="fas fa-paperclip"></i> image</label><input type="file" id="file-${msg.id}" class="reply-image-hidden" accept="image/*" style="display:none;" multiple></div><button class="send-reply-mini" data-parent="${msg.id}"><i class="fas fa-reply"></i> Post reply</button>`;
                        card.appendChild(replyBox);
                        card.querySelector('.reply-toggle-btn').addEventListener('click', () => { replyBox.style.display = replyBox.style.display === 'none' ? 'block' : 'none'; });
                        card.querySelector('.send-reply-mini').addEventListener('click', async () => {
                            const ta = replyBox.querySelector('textarea');
                            const content = ta.value.trim();
                            const fileInput = replyBox.querySelector('input[type="file"]');
                            const files = fileInput.files;
                            if (!content && (!files || files.length===0)) return alert('empty');
                            await postMessage(content, files ? Array.from(files) : null, msg.id);
                            ta.value = ''; fileInput.value = ''; replyBox.style.display = 'none';
                            loadMessages();
                        });
                        return card;
                    }

                    // preview & drag-drop
                    function updatePreview() {
                        globalPreview.innerHTML = '';
                        selectedFiles.forEach((f, idx) => {
                            const r = new FileReader();
                            r.onload = (e) => {
                                const thumb = document.createElement('div');
                                thumb.className = 'thumb-preview';
                                thumb.innerHTML = `<img src="${e.target.result}"><span class="remove-preview" data-index="${idx}">&times;</span>`;
                                globalPreview.appendChild(thumb);
                                thumb.querySelector('.remove-preview').addEventListener('click', () => {
                                    selectedFiles.splice(idx,1);
                                    updatePreview();
                                });
                            };
                            r.readAsDataURL(f);
                        });
                    }
                    messageInput.addEventListener('dragover', e => { e.preventDefault(); messageInput.classList.add('drag-over'); });
                    messageInput.addEventListener('dragleave', ()=> messageInput.classList.remove('drag-over'));
                    messageInput.addEventListener('drop', e => {
                        e.preventDefault(); messageInput.classList.remove('drag-over');
                        const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                        selectedFiles = [...selectedFiles, ...files];
                        updatePreview();
                    });
                    imageInput.addEventListener('change', () => {
                        selectedFiles = [...selectedFiles, ...Array.from(imageInput.files)];
                        updatePreview();
                    });

                    // formatting (simple wrap)
                    function insertWrap(before, after) {
                        const start = messageInput.selectionStart;
                        const end = messageInput.selectionEnd;
                        const text = messageInput.value;
                        messageInput.value = text.slice(0,start) + before + text.slice(start,end) + after + text.slice(end);
                    }
                    boldBtn.addEventListener('click', ()=> insertWrap('**','**'));
                    italicBtn.addEventListener('click', ()=> insertWrap('*','*'));
                    colorBtn.addEventListener('click', ()=> insertWrap(`<span style="color:${colorPicker.value};">`,'</span>'));

                    // send post
                    sendBtn.addEventListener('click', async ()=> {
                        const content = messageInput.value.trim();
                        await postMessage(content, selectedFiles.length ? selectedFiles : null, null);
                        messageInput.value = ''; selectedFiles = []; updatePreview(); imageInput.value = '';
                    });

                    // load more
                    document.getElementById('loadMoreBtn').addEventListener('click', () => {
                        renderedRootCount += PAGE_SIZE;
                        renderTopLevel();
                    });

                    // UI: login modal
                    openLoginBtn.addEventListener('click', ()=> { overlay.classList.add('active'); refreshUser(); });
                    closeModalBtn.addEventListener('click', ()=> overlay.classList.remove('active'));
                    loginTab.addEventListener('click', ()=> {
                        loginTab.classList.add('active'); signupTab.classList.remove('active');
                        loginFormDiv.style.display = 'block'; signupFormDiv.style.display = 'none';
                    });
                    signupTab.addEventListener('click', ()=> {
                        signupTab.classList.add('active'); loginTab.classList.remove('active');
                        signupFormDiv.style.display = 'block'; loginFormDiv.style.display = 'none';
                    });
                    switchToSignup.addEventListener('click', (e)=>{ e.preventDefault(); signupTab.click(); });
                    switchToLogin.addEventListener('click', (e)=>{ e.preventDefault(); loginTab.click(); });
                    loginBtn.addEventListener('click', login);
                    signupBtn.addEventListener('click', signUp);
                    settingsToggleBtn.addEventListener('click', async ()=>{
                        if (!currentUser) return alert('Login first');
                        await refreshUser();
                        if (currentProfile) {
                            settingsDisplayName.value = currentProfile.display_name || '';
                            avatarPreview.src = currentProfile.image_url || '';
                        }
                        settingsOverlay.classList.add('active');
                    });
                    closeSettingsBtn.addEventListener('click', ()=> settingsOverlay.classList.remove('active'));
                    logoutBtnSettings.addEventListener('click', logout);
                    closeEnlarge.addEventListener('click', ()=> enlargeOverlay.classList.remove('active'));
                    enlargeOverlay.addEventListener('click', (e)=> { if (e.target.classList.contains('enlarge-overlay')) enlargeOverlay.classList.remove('active'); });

                    // init
                    refreshUser().then(() => loadMessages());
                })();
            </script>
        </body>
        </html>
